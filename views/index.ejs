<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Home | Kariton</title>
  <link rel="shortcut icon" type="image/png" href="../assets/images/logos/favicon.png" />
  <link rel="stylesheet" href="../assets/css/styles.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body>
  <!-- Body Wrapper -->
  <div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
    data-sidebar-position="fixed" data-header-position="fixed">
    <!-- Sidebar Start -->
    <aside class="left-sidebar">
      <div>
        <div class="brand-logo d-flex align-items-center justify-content-between">
          <a href="/" class="text-nowrap logo-img">
            <img src="../img/image-removebg-preview (1) (2).png" width="180" style="opacity: 0.7;" alt="" />
          </a>
          <div class="close-btn d-xl-none d-block sidebartoggler cursor-pointer" id="sidebarCollapse">
            <i class="ti ti-x fs-8"></i>
          </div>
        </div>
        <div><%- include('./partials/sidebar'); -%></div>
      </div>
    </aside>
    <!-- Sidebar End -->
    <div class="body-wrapper">
      <!-- Header Start -->
      <div><%- include('./partials/head'); -%></div>
      <!-- Header End -->
      <div class="container-fluid">
        <!-- Row 1 -->
        <div class="row">
          <div class="col-lg-8 d-flex align-items-stretch">
            <div class="card w-100">
              <div class="card-body">
                <div class="d-sm-flex d-block align-items-center justify-content-between mb-9">
                  <div class="mb-3 mb-sm-0">
                    <h5 class="card-title fw-semibold">Most Sold Scraps</h5>
                  </div>
                  <div>
                    <select class="form-select" id="barangaySelect">
                      <% collectedData.forEach((data, index) => { %>
                        <option value="<%= index %>"><%= data.barangay['bName'] %></option>
                      <% }); %>
                    </select>
                  </div>
                </div>
                <div id="chart"></div>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="row">
              <div class="col-lg-12">
                <!-- Yearly Breakup -->
                <div class="card overflow-hidden">
                  <div class="card-body p-4">
                    <div class="row align-items-center">
                      <div class="col-8">
                        <h4 class="fw-semibold mb-3">Total Transactions: <%= totalTransactions %></h4>
                        <div class="d-flex align-items-center mb-3">
                          <span class="me-1 rounded-circle bg-light-success round-20 d-flex align-items-center justify-content-center">
                            <i class="ti ti-arrow-up-left text-success"></i>
                          </span>
                      
                        </div>
                      </div>
                      <div class="col-4">
                        <div class="d-flex justify-content-center">
                          <div id="breakup"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-lg-12">
                <!-- Monthly Earnings -->
                <div class="card">
                  <div class="card-body">
                    <div class="row align-items-start">
                      <div class="col-8">
                        <h5 class="card-title mb-9 fw-semibold">Total Number of Users</h5>
                        <h4 class="fw-semibold mb-3"><%=total %></h4>
                      </div>
                      <div class="col-4">
                        <div class="d-flex justify-content-end">
                          <div class="text-white bg-secondary rounded-circle p-6 d-flex align-items-center justify-content-center">
                            <i class="ti ti-population fs-6"></i>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div id="earning"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-4 d-flex align-items-stretch">
            <div class="card w-100">
              <div class="card-body p-4">
                <div class="mb-4">
                  <h5 class="card-title fw-semibold">Recent Transactions</h5>
                </div>
                <ul class="timeline-widget mb-0 position-relative mb-n5">
                  <!-- Timeline items for recent transactions -->
                  <% log.slice(-5).reverse().forEach((data, index) => { %> <!-- Apply reverse() here -->
                    <li class="timeline-item d-flex position-relative overflow-hidden">
                      <div class="timeline-time text-dark flex-shrink-0 text-end">
                        <%= data.time || '09:30' %> <!-- Replace '09:30' with dynamic time -->
                      </div>
                      <div class="timeline-badge-wrap d-flex flex-column align-items-center">
                        <span class="timeline-badge border-2 border border-primary flex-shrink-0 my-8"></span>
                        <span class="timeline-badge-border d-block flex-shrink-0"></span>
                      </div>
                      <div class="timeline-desc fs-3 text-dark mt-n1">
                        <%= data.logs %>
                      </div>
                    </li>
                  <% }); %>
                </ul>
                
              </div>
            </div>
          </div>
          <div class="col-lg-8">
            <div class="card w-100">
              <div class="card-body">
                <div class="d-sm-flex d-block align-items-center justify-content-between mb-4">
                  <h5 class="card-title fw-semibold">Monthly Transactions</h5>
                </div>
                <div id="monthlyTransactionsChart"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="collectedData" data-collected="<%= JSON.stringify(collectedData) %>"></div>
  <div id="collectedLogs" data-collected="<%= JSON.stringify(transactionsPerDay) %>"></div>
  <script>
    // Get the collected data from the DOM element
    const barangay = JSON.parse(document.getElementById('collectedData').dataset.collected);
    const monthlyTransactionsData = JSON.parse(document.getElementById('collectedLogs').dataset.collected);
  
    var transactionDates = monthlyTransactionsData.map(data => data.date); // Dates
    var transactionCounts = monthlyTransactionsData.map(data => data.count); // Counts
    console.log(transactionDates);
    // Function to extract scrap types and weights for the selected barangay
    function getBarangayData(barangayIndex) {
      const selectedBarangay = barangay[barangayIndex];
      const scrapTypes = [...new Set(selectedBarangay.collected.map(c => c.scrapType))].filter(Boolean); // Unique scrap types and remove null/undefined
      const weights = selectedBarangay.collected.map(c => c.weight).filter(Boolean); // Corresponding weights and remove null/undefined
  
      return { scrapTypes, weights };
    }
  
    // Function to check if there is valid data and show 'No current data found' if not
    function updateChartOrShowMessage(barangayData) {
      if (barangayData.scrapTypes.length === 0 || barangayData.weights.length === 0) {
        document.querySelector("#chart").innerHTML = "<p>No current data found</p>";
      } else {
        chart.updateOptions({
          xaxis: {
            categories: barangayData.scrapTypes // Update the scrap types (x-axis categories)
          },
          series: [{
            name: 'Scrap',
            data: barangayData.weights // Update the weights (y-axis data)
          }]
        });
      }
    }
  
    // Get initial data for the first barangay (default)
    let initialData = getBarangayData(0);
  
    // Initial Chart Options
    var options = {
      chart: {
        type: 'bar',
        height: 350
      },
      series: [{
        name: 'Scrap',
        data: initialData.weights // Default to the first barangay's weights
      }],
      xaxis: {
        categories: initialData.scrapTypes // Default to the first barangay's scrap types
      }
    };
  
    var chart = new ApexCharts(document.querySelector("#chart"), options);
    chart.render();
  
    // Check initial data and update or show message
    updateChartOrShowMessage(initialData);
  
    // Update chart based on barangay selection
    document.getElementById("barangaySelect").addEventListener("change", function () {
      var selectedBarangayIndex = this.value;
      var barangayData = getBarangayData(selectedBarangayIndex);
  
      // Update the chart or show 'No current data found'
      updateChartOrShowMessage(barangayData);
    });
  
    // Chart for Monthly Transactions (unchanged)
    var monthlyOptions = {
      chart: {
        type: 'line',
        height: 350
      },
      series: [{
        name: 'Transactions',
        data: transactionCounts // Example data for monthly transactions
      }],
      xaxis: {
        categories: transactionDates
      }
    };
  
    var monthlyChart = new ApexCharts(document.querySelector("#monthlyTransactionsChart"), monthlyOptions);
    monthlyChart.render();
  </script>
    <script src="../assets/libs/jquery/dist/jquery.min.js"></script>
    <script src="../assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/sidebarmenu.js"></script>
    <script src="../assets/js/app.min.js"></script>
    <script src="../assets/libs/simplebar/dist/simplebar.js"></script>
</body>

</html>
